# ============================================================
# MJ's Superstars - Render Blueprint (Full Stack)
# One-click deployment for the complete application
# ============================================================
# Deploy: Connect repo to Render → Select "Blueprint" → Deploy
# Docs: https://render.com/docs/infrastructure-as-code

services:
  # ==========================================================
  # BACKEND API (Node.js + Express + Socket.IO)
  # ==========================================================
  - type: web
    name: mj-superstars-api
    runtime: node
    region: ohio
    plan: starter  # Upgrade to "standard" ($25/mo) for production traffic
    rootDir: mj-superstars-backend
    buildCommand: npm ci && npm run build
    startCommand: node src/server.js
    healthCheckPath: /health
    autoDeploy: true
    envVars:
      # Core
      - key: NODE_ENV
        value: production
      - key: PORT
        value: "10000"

      # Database
      - key: DATABASE_URL
        fromDatabase:
          name: mj-superstars-db
          property: connectionString

      # Redis
      - key: REDIS_URL
        fromService:
          name: mj-superstars-redis
          type: redis
          property: connectionString

      # JWT Authentication
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_EXPIRES_IN
        value: "15m"
      - key: REFRESH_TOKEN_EXPIRES_IN
        value: "7d"

      # Claude AI
      - key: ANTHROPIC_API_KEY
        sync: false  # Set in Render dashboard
      - key: CLAUDE_MODEL
        value: "claude-sonnet-4-20250514"
      - key: MAX_TOKENS
        value: "1024"

      # Frontend URL (update after frontend deploys)
      - key: CLIENT_URL
        sync: false

      # Push Notifications (VAPID)
      - key: VAPID_PUBLIC_KEY
        sync: false
      - key: VAPID_PRIVATE_KEY
        sync: false
      - key: VAPID_SUBJECT
        value: "mailto:support@mjsuperstars.com"

      # Error Tracking (Sentry)
      - key: SENTRY_DSN
        sync: false
      - key: APP_VERSION
        value: "1.0.0"

      # Rate Limiting
      - key: RATE_LIMIT_WINDOW_MS
        value: "900000"
      - key: RATE_LIMIT_MAX_REQUESTS
        value: "100"

      # Logging
      - key: LOG_LEVEL
        value: "info"

  # ==========================================================
  # FRONTEND (React/Capacitor - Static Site)
  # ==========================================================
  - type: web
    name: mj-superstars-web
    runtime: static
    region: ohio
    plan: starter
    rootDir: mj-superstars-frontend
    buildCommand: npm ci && npm run build
    staticPublishPath: ./build
    headers:
      - path: /*
        name: X-Frame-Options
        value: DENY
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      - path: /*
        name: Referrer-Policy
        value: strict-origin-when-cross-origin
    routes:
      - type: rewrite
        source: /*
        destination: /index.html
    envVars:
      - key: REACT_APP_API_URL
        sync: false  # Set to API URL after deploy
      - key: REACT_APP_SOCKET_URL
        sync: false
      - key: REACT_APP_SENTRY_DSN
        sync: false
      - key: REACT_APP_MIXPANEL_TOKEN
        sync: false
      - key: REACT_APP_VERSION
        value: "1.0.0"

  # ==========================================================
  # BACKGROUND WORKER (Job Processing)
  # ==========================================================
  - type: worker
    name: mj-superstars-worker
    runtime: node
    region: ohio
    plan: starter
    rootDir: mj-superstars-backend
    buildCommand: npm ci
    startCommand: node src/workers/jobProcessor.js
    autoDeploy: true
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: mj-superstars-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: mj-superstars-redis
          type: redis
          property: connectionString
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: SENTRY_DSN
        sync: false

  # ==========================================================
  # CRON JOBS (Scheduled Tasks)
  # ==========================================================
  - type: cron
    name: mj-daily-cleanup
    runtime: node
    region: ohio
    plan: starter
    rootDir: mj-superstars-backend
    buildCommand: npm ci
    schedule: "0 2 * * *"  # 2 AM daily
    startCommand: node -e "import('./src/services/gdpr.js').then(m => m.runDataRetentionCleanup())"
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: mj-superstars-db
          property: connectionString

# ==========================================================
# DATABASES
# ==========================================================
databases:
  - name: mj-superstars-db
    region: ohio
    plan: starter  # $7/mo - upgrade for production
    databaseName: mj_superstars
    user: mj_admin
    postgresMajorVersion: "16"
    ipAllowList: []  # Internal only

# ==========================================================
# REDIS (Sessions, Caching, Job Queues)
# ==========================================================
  - name: mj-superstars-redis
    type: redis
    region: ohio
    plan: starter  # $7/mo
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []
