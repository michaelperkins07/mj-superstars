# ============================================================
# MJ's Superstars - Render Blueprint (Infrastructure as Code)
# ============================================================
# Deploy with: Connect this repo to Render and use "Blueprint" mode
# Docs: https://render.com/docs/infrastructure-as-code

services:
  # ----------------------------------------------------------
  # API Server (Node.js + Express + Socket.IO)
  # ----------------------------------------------------------
  - type: web
    name: mj-superstars-api
    runtime: node
    region: ohio  # US East - low latency for US users
    plan: starter  # $7/mo - upgrade to Standard ($25/mo) for production
    buildCommand: npm ci --production=false && npm run build
    startCommand: node src/server.js
    healthCheckPath: /health
    autoDeploy: true
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: "10000"  # Render assigns port via this env var
      - key: CLIENT_URL
        sync: false  # Set manually after frontend deploy
      - key: DATABASE_URL
        fromDatabase:
          name: mj-superstars-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: mj-superstars-cache
          type: redis
          property: connectionString
      - key: JWT_SECRET
        generateValue: true  # Render auto-generates a secure random string
      - key: JWT_EXPIRES_IN
        value: "15m"
      - key: REFRESH_TOKEN_EXPIRES_IN
        value: "7d"
      - key: ANTHROPIC_API_KEY
        sync: false  # Set manually in Render dashboard
      - key: CLAUDE_MODEL
        value: "claude-sonnet-4-20250514"
      - key: MAX_TOKENS
        value: "1024"
      - key: VAPID_PUBLIC_KEY
        sync: false  # Generate and set manually
      - key: VAPID_PRIVATE_KEY
        sync: false  # Generate and set manually
      - key: VAPID_SUBJECT
        sync: false
      - key: LOG_LEVEL
        value: "info"
      - key: RATE_LIMIT_WINDOW_MS
        value: "900000"
      - key: RATE_LIMIT_MAX_REQUESTS
        value: "100"

  # ----------------------------------------------------------
  # Database Migration Job (runs on deploy)
  # ----------------------------------------------------------
  - type: worker
    name: mj-superstars-migrate
    runtime: node
    region: ohio
    plan: starter
    buildCommand: npm ci
    startCommand: node src/database/migrate.js
    autoDeploy: false  # Trigger manually or via deploy hook
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: mj-superstars-db
          property: connectionString

# ----------------------------------------------------------
# Databases
# ----------------------------------------------------------
databases:
  - name: mj-superstars-db
    region: ohio
    plan: starter  # $7/mo, 1GB storage, 256MB RAM
    databaseName: mj_superstars
    user: mj_admin
    postgresMajorVersion: "16"
    ipAllowList: []  # Empty = internal only (more secure)

# ----------------------------------------------------------
# Redis Cache (for sessions, rate limiting, real-time)
# ----------------------------------------------------------
  - name: mj-superstars-cache
    type: redis
    region: ohio
    plan: starter  # $7/mo
    ipAllowList: []
    maxmemoryPolicy: allkeys-lru
